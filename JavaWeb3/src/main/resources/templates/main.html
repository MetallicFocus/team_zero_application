<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Main</title>
    <link rel="stylesheet" type="text/css" href="/style/theme/index.css"/>
	<link rel="stylesheet" type="text/css" href="/style/main.css"/>
    <script type="text/javascript" src="/js/vue.js"></script>
	<script type="text/javascript" src="/js/md5.js"></script>
    <script type="text/javascript" src="/js/element-ui.js"></script>
	<script type="text/javascript" src="/js/vue-components.js"></script>
    <script src="/js/node_modules/vue-cookies/vue-cookies.js"></script>
</head>
<body>
<div id="app">
    <div id="main-panel">
    <!--Todo: Sign out-->
	<el-container>
        <el-aside id="left-panel">
            <el-header id="self-info">
                <el-row>
					<el-col :span="8"><el-avatar class="avatar" :src="self.avatar" style="margin-top: 5px;"></el-avatar></el-col>
					<el-col :span="12"><label style="font-size: 30px; text-align: left;">{{self.name}}</label></el-col>
					<el-col :span="2"><i id="add" class="el-icon-circle-plus-outline" @click="showSearchPanel"></i></el-col>
				</el-row>
			</el-header>
            <el-header id="search-bar">
                <el-input v-model="search" placeholder="Search for history" style="width: 195px;"></el-input>
                <el-button icon="el-icon-search" type="primary" @click="searchHistory(searchField)"></el-button>                
            </el-header>
            <el-main id="chat-list-panel">
                <single-chat v-on:click-id="showchat(chat.id)" v-for="chat in chatlist" v-bind:key="chat.id" :id="chat.id" :avatar="chat.avatar" :name="chat.name" :time="chat.time" :content="chat.content"></single-chat>
            </el-main>
        </el-aside>
        <single-chat-panel v-for="chat in chatlist" v-on:send-message="text2($event, args)" v-bind:key="chat.id" :chat="chat" v-show="chat.show"></single-chat-panel>
    </el-container>
	</div>
	<div v-show="searchUserForm.display">
		<div id="mask"></div>
		<div id="searchUserPanel">
			<el-input v-model="searchUserForm.searchField" placeholder="Please input user name" style="margin-left: 160px; margin-top: 50px; width: 400px;"></el-input>
			<el-button icon="el-icon-search" type="primary" @click="searchUsers()"></el-button>
			<div id="searchResults">
				<label>Search results are as follows:</label>
				<single-user-info @chat="chatwith(userdata.username)" class="single-user-info" v-for="userdata in searchUserForm.usersdata" :username="userdata.username" :email="userdata.email" :isloggedin="userdata.IsLoggedIn"></single-user-info>
			</div>
			<el-button style="margin-left: 350px; margin-top: 10px;" @click="closeSearchPanel">Cancel</el-button>
		</div>
	</div>
</div>
</body>

<script>
        new Vue({
            el: '#app',
            data: function() {
                return {
					args: [],
					searchUserForm: {
						display: false,
						searchField: "",
						usersdata:[]
					},
                    websocket: null,
                    request: '',
                    response: '',
                    parsed_response: '',
					onmessage_flag: false,
                    self: {
                        avatar: "/img/avatar.jpg",
                        name: "User1"
                    },
                    search: "",
					chat_num: 1,
                    chatlist: [
                        {
                            id: "1",
                            avatar: "/img/avatar.jpg",
                            name: "Template",
                            time: "00:00",
                            content: "Me: test!",
                            show: 1,
                            messages: [
                                {
                                    avatar: "/img/avatar.jpg",
                                    time: "00:00",
                                    content: "11111111111!",
                                    objectflag: 1
                                },
                                {
                                    avatar: "/img/avatar.jpg",
                                    time: "00:00",
                                    content: "22222222222!",
                                    objectflag: 0
                                }
                            ]
                        }
					]
				}
            },
            mounted() {
                if ('WebSocket' in window) {
                    this.websocket = new WebSocket('ws://localhost:1234');
                    this.initWebSocket();
                } else {
                    alert('Websocket is not supported by this browser!');
                    return null;
                }
            },
            beforeDestroy() {
                this.websocket.close();
            },
			watch:{
				response(newR, oldR) {
					console.log("Watched newR: " + newR);
					this.parsed_response = JSON.parse(newR);
					console.log(this.parsed_response);
					switch (this.parsed_response.type) {
						case 'TEXT': 
							if (this.parsed_response.recipient !== this.self.name) return; //error forwarded message						
							sender = this.parsed_response.sender;
							message = this.parsed_response.message;
							this.chatwith(sender);
							//Todo: retrieve time instead of creating
							time = new Date();
							this.updateChat(sender, this.self.name, message, time);
							break;
						case 'REPLY':
							switch (this.parsed_response.REPLY) {
								case 'LOGIN: SUCCESS':
									console.log("LOGIN: SUCCESS");
									this.initPost(this.self.name);
									break;
								case 'GETALLCONTACTS: SUCCESS':
									contacts = this.parsed_response.contacts;
									for (i in contacts) {
										if (contacts[i].username !== this.self.name)
											this.chatwith(contacts[i].username);
									}
									break;
								case 'SEARCHCONTACTS: SUCCESS':
									if (this.parsed_response.contacts.length > 1)
										this.searchUserForm.usersdata = this.parsed_response.contacts;
									else
										this.searchUserForm.usersdata = [this.parsed_response.contacts];
									break;
							}
							break;
					}
				}
			},
            methods: {
                initWebSocket() {
                    //connection occurs error
                    this.websocket.onerror = this.setErrorMessage;
                    //connection succeeds
                    this.websocket.onopen = this.setOnopenMessage;
                    //get response from Server
                    this.websocket.onmessage = this.setOnmessageMessage;
                    //connection closes
                    this.websocket.onclose = this.setOncloseMessage;
                    //connection closes automatically after leaving websites
                    window.onbeforeunload = this.onBeforeUnload;
                },
                setErrorMessage() {
                    this.response = "WebSocket occurs error." + '   Status：' + this.websocket.readyState;
                },
                setOnopenMessage() {
                    this.response = "WebSocket succeeds." + '   status：' + this.websocket.readyState;
                    this.doubleLogin();
                },
                setOnmessageMessage(event) {
                    this.response = event.data;
					this.onmessage_flag = true;
                },
                setOncloseMessage() {
                    this.response = "WebSocket closes." + '   status：' + this.websocket.readyState;
                },
                onBeforeUnload() {
                    this.websocket.close();
                },
                //send message (JSON) to Server
                send() {
                    this.websocket.send(this.request);
                },
                showchat : function(id) {
                    for (var chat_key of Object.keys(this.chatlist)) {
                        if (this.chatlist[chat_key].id !== id) {
                            this.chatlist[chat_key].show = 0;
                        } else {
                            this.chatlist[chat_key].show = 1;
                        }
                    }
                },
                text2 : function (args) {
					recipient = args[0];
                    message = args[1];
					time = new Date(); //Todo: formalize date
                    this.request =
                        "{\"type\": \"TEXT\"" +
                        ", \"sender\":\"" + this.self.name +
                        "\", \"recipient\":\"" + recipient +
                        "\", \"message\":\""+ message + "\"}";
                    this.send();
                    //Todo: determine text successful
					// if (this.parsed_response.REPLY === 'TEXT: SUCCESS'){
                    //     this.updateChat(recipient, message);
                    // } else {
                    //     console.log(this.parsed_response.message);
                    // }
                    this.updateChat(this.self.name, recipient, message, time);
                },
                updateChat : function (sender, recipient, message, time) {
					hour = time.getHours();
					paddingHour = hour>9?"":"0";
					minute = time.getMinutes();
					paddingMinute = minute>9?"":"0";
					time = paddingHour + hour + ":" + paddingMinute + minute;
                    if (sender===this.self.name) { //message out
						for (chat_key in this.chatlist) {
						    if (this.chatlist[chat_key].name === recipient) {
								message_key = this.chatlist[chat_key].messages.length;
						        Vue.set(this.chatlist[chat_key].messages, message_key, {
						            'avatar': "/img/avatar.jpg",
						            'time': time,
						            'content': message,
						            'objectflag': 0
						        });
						    }
						}
					} else {
						for (chat_key in this.chatlist) { //message in
						    if (this.chatlist[chat_key].name === sender) {
								message_key = this.chatlist[chat_key].messages.length;
						        Vue.set(this.chatlist[chat_key].messages, message_key, {
						            'avatar': "/img/avatar.jpg",
						            'time': time,
						            'content': message,
						            'objectflag': 1
						        });
						    }
						}
					}
					
                    //Todo: animation: slide down to the new message
                },
                searchHistory : function (searchField) {

                },
                showSearchPanel : function () {
                	this.searchUserForm.display = true;
                },
                closeSearchPanel : function () {
                	this.searchUserForm.display = false;
                },
                chatwith : function (username) {
					if (username === this.self.name) return; //Todo: chat with oneself
                    for (chat_key in this.chatlist) {
						if (this.chatlist[chat_key].name === username) {
							//check if chat is already existed
							//Todo: to correct: chat panel dispears for a while
							this.closeSearchPanel();
							this.showchat(++chat_key);
							return;
						}
					}
					Vue.set(this.chatlist, this.chat_num, {
                        'id': ++this.chat_num,
                        'avatar': "/img/avatar.jpg",
                        'name': username,
                        'time': '',
                        'content': '',
                        'show': 0,
                        'messages': []
                    });
					this.closeSearchPanel();
					this.showchat(this.chat_num);
                },
                searchUsers : function () {
                    this.request = "{\n" +
                        "type: \"SEARCHCONTACTS\",\n" +
                        "search:\"" + this.searchUserForm.searchField + "\",\n" +
                        "}";
                    this.send();
					
					//Todo: fail to search					
                },
                doubleLogin : function() {
                    username = this.$cookies.get('username');
                    password = this.$cookies.get('password');
                    this.request = "{\n" +
                        "type: \"LOGIN\",\n" +
                        "username:\""+ username +"\",\n" +
                        "password:\"" + password + "\"\n" +
                        "}";
                    this.send();
                    this.$cookies.remove('password');
                },
				initPost : function() {
					this.self = {'avatar': "/img/avatar.jpg", 'name': this.$cookies.get('username')};
					this.request = "{\n" +
										"type: \"GETALLCONTACTS\",\n" +
									"}";
					this.send();
				}
            }
        })
</script>

</html>
